name: Update ECS services

on:
  workflow_dispatch:
  
env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

jobs:

  CI:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./testing

    steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 1
            ref: main
    
        - uses: hashicorp/setup-terraform@v2

        - name: init
          run: terraform init

        - name: validate
          run: terraform validate

        - name: plan
          run: terraform plan

        - name: apply
          run: terraform apply -var 'container_image=${{ vars.PYDBCAPSTONE_IMAGE_VER_LATEST }}' -auto-approve

        - name: update ALB DNS name
          run: |
            cat alb_dns_url.dat
            source alb_dns_url.dat
            curl -L -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: Bearer $ACCESS_TOKEN" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/orgs/friends-ce-3-group/actions/variables/ECS_ALB_DNS -d '{"name":"ECS_ALB_DNS","value":"'$ALB_DNS_URL'","visibility":"all"}'